name: üß™ An√°lisis Est√°tico - Calidad y Seguridad del C√≥digo

on:
  push:
    branches: [main]
  pull_request:

jobs:
  analisis:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout del repositorio
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Instalar Flutter (versi√≥n estable compatible con Dart 3.8.1)
      - name: Instalar Flutter 3.32.4
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.4'
          channel: 'stable'
          cache: true

      - name: Verificar versi√≥n de Flutter
        run: flutter --version

      # 3Ô∏è‚É£ Instalar Dart SDK (necesario para SonarCloud)
      - name: Instalar Dart SDK
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      - name: Verificar versi√≥n de Dart
        run: dart --version

      # 4Ô∏è‚É£ Obtener dependencias
      - name: Obtener dependencias del proyecto
        run: flutter pub get

      # 5Ô∏è‚É£ Ejecutar pruebas unitarias con cobertura
      - name: Ejecutar pruebas con cobertura
        run: flutter test --coverage

      # 6Ô∏è‚É£ Crear archivo de configuraci√≥n de SonarCloud din√°micamente
      - name: Crear archivo sonar-project.properties
        run: |
          echo "sonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}" >> sonar-project.properties
          echo "sonar.organization=${{ secrets.SONAR_ORG }}" >> sonar-project.properties
          echo "sonar.host.url=https://sonarcloud.io" >> sonar-project.properties
          echo "sonar.sources=lib" >> sonar-project.properties
          echo "sonar.tests=test" >> sonar-project.properties
          echo "sonar.javascript.lcov.reportPaths=coverage/lcov.info" >> sonar-project.properties
          echo "sonar.dart.analyzer.skip=true" >> sonar-project.properties
          echo "sonar.c.file.suffixes=-" >> sonar-project.properties
          echo "sonar.cpp.file.suffixes=-" >> sonar-project.properties
          echo "sonar.objc.file.suffixes=-" >> sonar-project.properties

      # 7Ô∏è‚É£ An√°lisis con SonarCloud
      - name: An√°lisis con SonarCloud
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: .

      # 8Ô∏è‚É£ An√°lisis con Semgrep (seguridad est√°tica)
      - name: An√°lisis con Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: "p/ci"

      # 9Ô∏è‚É£ An√°lisis con Snyk (vulnerabilidades en dependencias)
      - name: An√°lisis con Snyk
        uses: snyk/actions/setup@v1
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test

      # üîü (Opcional) Subir el reporte HTML de cobertura como artefacto descargable
      - name: Subir reporte de cobertura HTML
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reporte-cobertura
          path: coverage/
