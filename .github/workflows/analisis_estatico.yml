name: ðŸ§ª AnÃ¡lisis EstÃ¡tico - Calidad y Seguridad del CÃ³digo

on:
  push:
    branches: [main]
  pull_request:

jobs:
  analisis:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      # âœ… Instalar Flutter 3.27.1 (Dart 3.8.1)
      - name: Instalar Flutter 3.27.1
        run: |
          wget https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_3.27.1-stable.tar.xz
          tar xf flutter_linux_3.27.1-stable.tar.xz
          export PATH="$PATH:$PWD/flutter/bin"
          flutter --version

      - name: Obtener dependencias
        run: |
          export PATH="$PATH:$PWD/flutter/bin"
          flutter pub get

      # ðŸ”¹ 1. AnÃ¡lisis con SonarCloud
      - name: AnÃ¡lisis con SonarCloud
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: .
          args: >
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.organization=${{ secrets.SONAR_ORG }}
            -Dsonar.qualitygate.wait=true
            -Dsonar.dart.coverage.reportPaths=coverage/lcov.info
            -Dsonar.c.file.suffixes=-
            -Dsonar.cpp.file.suffixes=-
            -Dsonar.objc.file.suffixes=-
            -Dsonar.dart.file.suffixes=-

      # ðŸ”¹ 2. AnÃ¡lisis con Semgrep
      - name: AnÃ¡lisis con Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: "p/ci"

      # ðŸ”¹ 3. AnÃ¡lisis con Snyk
      - name: AnÃ¡lisis con Snyk
        uses: snyk/actions/setup@v1
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test
