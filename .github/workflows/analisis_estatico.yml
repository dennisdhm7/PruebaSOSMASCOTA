name: üß™ An√°lisis Est√°tico - Calidad y Seguridad del C√≥digo

on:
  push:
    branches: [main]
  pull_request:

jobs:
  analisis:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout del repositorio
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Instalar Flutter (USAMOS EL M√âTODO ESTABLE DE ACCI√ìN)
      - name: Instalar Flutter 3.24.3
        uses: subosito/flutter-action@v2
        with:
          # NOTA: Cambia '3.24.3' a la versi√≥n M√ÅS RECIENTE
          # compatible con Dart ^3.8.1 si '3.24.3' no funciona.
          flutter-version: '3.24.3' 
          channel: 'stable'
          cache: true

      - name: Verificar versi√≥n de Flutter
        run: flutter --version

      # 3Ô∏è‚É£ Obtener dependencias (EJECUTADO DENTRO DE LA CARPETA DE LA APP)
      - name: Obtener dependencias
        run: cd SosMascota && flutter pub get

      # 4Ô∏è‚É£ Ejecutar pruebas con cobertura (EJECUTADO DENTRO DE LA CARPETA DE LA APP)
      - name: Ejecutar pruebas con cobertura
        run: cd SosMascota && flutter test --coverage

      # 5Ô∏è‚É£ An√°lisis con SonarCloud 
      - name: An√°lisis con SonarCloud
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          # APUNTA A LA CARPETA DE LA APP
          projectBaseDir: SosMascota 
          args: >
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.organization=${{ secrets.SONAR_ORG }}
            -Dsonar.qualitygate.wait=true
            # RUTA DEL REPORTE ES RELATIVA A 'SosMascota'
            -Dsonar.dart.coverage.reportPaths=coverage/lcov.info
            -Dsonar.c.file.suffixes=-
            -Dsonar.cpp.file.suffixes=-
            -Dsonar.objc.file.suffixes=-
            # REMOVEMOS la exclusi√≥n de Dart (antes estaba -Dsonar.dart.file.suffixes=-)

      # 6Ô∏è‚É£ An√°lisis con Semgrep
      - name: An√°lisis con Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: "p/ci"

      # 7Ô∏è‚É£ An√°lisis con Snyk
      - name: An√°lisis con Snyk
        uses: snyk/actions/setup@v1
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test
